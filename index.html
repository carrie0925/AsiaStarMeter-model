<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>Asia Star Meter</title>

    <!-- Vapor ä¸»é¡Œ -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/vapor/bootstrap.min.css"
    />
    <style>
      body {
        padding: 2rem;
      }
      #preview {
        max-width: 300px;
        max-height: 400px;
        border-radius: 10px;
        border: 1px solid #888;
        display: none;
      }
      #result-card {
        margin-top: 2rem;
        font-size: 1.25rem;
        font-weight: 500;
      }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
  </head>
  <body class="container text-center">
    <h1 class="mb-4">ğŸŒŸ Asia Star Meter</h1>

    <!-- æª”æ¡ˆé¸æ“‡å€ -->
    <div class="mb-3 d-flex justify-content-center gap-3 flex-wrap">
      <input
        class="form-control btn btn-secondary w-auto"
        type="file"
        id="imageUpload"
        accept="image/*"
      />
      <button class="btn btn-primary" onclick="handleImageUpload()">
        Check
      </button>
    </div>

    <!-- åœ–ç‰‡èˆ‡çµæœ -->
    <div class="d-flex justify-content-center">
      <img id="preview" alt="é è¦½åœ–ç‰‡" />
    </div>
    <div id="label-container" class="mt-4"></div>

    <script>
      const modelBasePath = "tm-my-image-model/";
      let model, maxPredictions;

      async function loadModel() {
        try {
          const modelURL = modelBasePath + "model.json";
          const metadataURL = modelBasePath + "metadata.json";
          model = await tmImage.load(modelURL, metadataURL);
          maxPredictions = model.getTotalClasses();
          console.log("âœ… æ¨¡å‹å·²è¼‰å…¥å®Œæˆ");
        } catch (e) {
          alert("âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼");
          console.error(e);
        }
      }

      loadModel();

      function handleImageUpload() {
        const input = document.getElementById("imageUpload");
        const file = input.files[0];
        if (!file) {
          alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼");
          return;
        }

        const preview = document.getElementById("preview");
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";

        preview.onload = () => {
          predict(preview);
        };

        preview.onerror = () => {
          alert("âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹æ›ä¸€å¼µåœ–ç‰‡ï¼");
        };
      }

      async function predict(imageElement) {
        try {
          if (!model) {
            alert("æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆï¼");
            return;
          }

          const prediction = await model.predict(imageElement);
          const idolScore = prediction.find(
            (p) => p.className === "idol"
          ).probability;

          let resultText = "";
          if (idolScore >= 0.8) {
            resultText = "ğŸŒŸ å‡ºé“æ½›åŠ›æ¥µé«˜ï¼ä½ å°±æ˜¯ä¸‹ä¸€å€‹å¶åƒï¼";
          } else if (idolScore >= 0.5) {
            resultText = "âœ¨ æœ‰æ½›åŠ›ï¼æŒçºŒåŠªåŠ›å°±æœ‰æ©Ÿæœƒå‡ºé“ï¼";
          } else {
            resultText = "ğŸ’¬ ç›®å‰é‚„ä¸å¤ªé©åˆå‡ºé“ï¼Œä½†æ¯å€‹äººéƒ½æœ‰ä¸åŒé­…åŠ›ï¼";
          }

          const container = document.getElementById("label-container");
          container.innerHTML = `<div class="alert alert-info" id="result-card">${resultText}</div>`;
        } catch (err) {
          console.error("âŒ é æ¸¬éŒ¯èª¤ï¼š", err);
          alert("âš ï¸ é æ¸¬å¤±æ•—ï¼Œè«‹ç¢ºèªåœ–ç‰‡æ ¼å¼æ­£ç¢ºã€‚");
        }
      }
    </script>
  </body>
</html>
